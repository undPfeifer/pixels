<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Supabase Gallery Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .image-container {
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .image-container img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }
    .image-name {
      padding: 10px;
      font-size: 12px;
      background: #f5f5f5;
      word-break: break-all;
    }
    .error {
      color: red;
      padding: 10px;
      background: #ffe6e6;
      border-radius: 4px;
      margin: 10px 0;
    }
    .info {
      color: #666;
      padding: 10px;
      background: #f0f0f0;
      border-radius: 4px;
      margin: 10px 0;
    }
    button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <h1>Supabase Gallery Test</h1>
  
  <div>
    <button onclick="loadImagesFromList()">Try List Method</button>
    <button onclick="loadKnownImages()">Load Known Images</button>
    <button onclick="testBucketAccess()">Test Bucket Access</button>
  </div>
  
  <div id="status"></div>
  <div id="gallery" class="gallery"></div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://nalnmysgfilnxectuafq.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5hbG5teXNnZmlsbnhlY3R1YWZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5NDAxMDIsImV4cCI6MjA2NTUxNjEwMn0.BWjUc8A9wnaoOt7mQKvCycN5kH9tneS07p4tMcxtMGQ'
    );

    function setStatus(message, isError = false) {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="${isError ? 'error' : 'info'}">${message}</div>`;
    }

    function clearGallery() {
      document.getElementById('gallery').innerHTML = '';
    }

    function renderImage(url, filename = '') {
      const container = document.createElement('div');
      container.className = 'image-container';
      
      const img = document.createElement('img');
      img.src = url;
      img.alt = filename || 'Gallery Image';
      img.onerror = () => {
        container.innerHTML = `<div style="padding: 20px; text-align: center; color: red;">Failed to load: ${filename}</div>`;
      };
      
      container.appendChild(img);
      
      if (filename) {
        const nameDiv = document.createElement('div');
        nameDiv.className = 'image-name';
        nameDiv.textContent = filename;
        container.appendChild(nameDiv);
      }
      
      document.getElementById('gallery').appendChild(container);
    }

    // Method 1: Try the original list approach
    window.loadImagesFromList = async function() {
      clearGallery();
      setStatus('Loading images using list method...');
      
      try {
        const { data, error } = await supabase.storage
          .from('projects')
          .list('', { 
            limit: 1000,
            sortBy: { column: 'name', order: 'asc' }
          });

        if (error) {
          console.error('List error:', error);
          setStatus(`Error: ${error.message}. This usually means the bucket doesn't allow public listing.`, true);
          return;
        }

        console.log('Files found:', data);
        
        if (!data || data.length === 0) {
          setStatus('No files found or bucket listing not allowed.', true);
          return;
        }

        setStatus(`Found ${data.length} files. Loading images...`);
        
        data.forEach(file => {
          if (file.name && !file.name.endsWith('/')) { // Skip folders
            const { data: urlData } = supabase.storage
              .from('projects')
              .getPublicUrl(file.name);
            
            renderImage(urlData.publicUrl, file.name);
          }
        });
        
      } catch (err) {
        console.error('Unexpected error:', err);
        setStatus(`Unexpected error: ${err.message}`, true);
      }
    };

    // Method 2: Load known images (hardcoded list)
    window.loadKnownImages = function() {
      clearGallery();
      setStatus('Loading known images...');
      
      const knownImages = [
        'Bildschirmfoto%202025-05-09%20um%2013.47.02.png',
        // Add more filenames here as you upload them
      ];
      
      knownImages.forEach(filename => {
        const { data: urlData } = supabase.storage
          .from('projects')
          .getPublicUrl(filename);
        
        renderImage(urlData.publicUrl, decodeURIComponent(filename));
      });
      
      setStatus(`Loaded ${knownImages.length} known images.`);
    };

    // Method 3: Test bucket access
    window.testBucketAccess = async function() {
      clearGallery();
      setStatus('Testing bucket access...');
      
      try {
        // Test if we can access the known file directly
        const testUrl = 'https://nalnmysgfilnxectuafq.supabase.co/storage/v1/object/public/projects/Bildschirmfoto%202025-05-09%20um%2013.47.02.png';
        
        const response = await fetch(testUrl, { method: 'HEAD' });
        
        if (response.ok) {
          setStatus('✅ Direct file access works! The bucket allows public file access but not listing.');
          renderImage(testUrl, 'Bildschirmfoto 2025-05-09 um 13.47.02.png');
        } else {
          setStatus(`❌ Direct file access failed. Status: ${response.status}`, true);
        }
        
        // Also test the list operation
        const { data, error } = await supabase.storage
          .from('projects')
          .list('', { limit: 1 });
          
        if (error) {
          setStatus(prev => prev + `<br>❌ List operation failed: ${error.message}`, true);
        } else {
          setStatus(prev => prev + '<br>✅ List operation works!');
        }
        
      } catch (err) {
        setStatus(`Test failed: ${err.message}`, true);
      }
    };

    // Auto-run the test on page load
    window.addEventListener('load', () => {
      testBucketAccess();
    });
  </script>
</body>
</html>
